---
description: 역시 가상화는 오버 엔지니어링이었다.
---

# Moving Unifi Controller to Bare Metal RPi

기존에 도커 스웜에서 돌렸던 유니파이 컨트롤러를 이사하면서 라즈베리파이 3 한대를 온전히 쓰도록 변경했다. 

옮기게 된 이유는 다음과 같다

* 도커 스웜의 오버레이 네트워크를 통해 접근하게 하면 컨트롤러가 접근을 거부하고, Traefik을 활용해 도메인을 할당했더니 크롬이 SSL 문제로 접근을 차단한다.
* 이사하면서 도커 스웜을 꺼버렸는데 컨트롤러에 볼륨을 연결하지 않아서 모든 설정과 데이터가 날아갔다. \(...\) 
  * 사실 이게 가장 큰 이유다. 빡쳐서 집어친 느낌으로....

결국 라즈베리파이 클러스터 중에서 가장 저성능인 라즈베리파이 3 한대를 라즈비안 라이트와 함께 재설치한 후 컨트롤러를 설정했다. 

## 컨트롤러 설정 

먼저 ssh 를 활성화한 라즈비안 라이트를 설치한 후 라즈베리 파이와 컴퓨터를 직접 연결 후 ssh로 접속해 `raspi-config` 로 여러가지 설정을 수행했다. 

* 라즈베리파이 호스트네임 변경 -&gt; `unipi-controller.local`
* 타임존과 메모리, wlan 비활성화
* 비밀번호 변

컨트롤러 설치는 도커보다는 약간 복잡하지만 그래도 간단하다.

```text
$ sudo apt update && sudo apt upgrade
$ sudo apt install haveged -y
$ sudo apt install openjdk-8-jre-headless -y
$ wget https://dl.ui.com/unifi/5.14.22/unifi_sysvinit_all.deb
$ sudo dpkg -i unifi_sysvinit_all.deb; sudo apt install -f -y
```

## 네트워크 설정

컨트롤러에 접속해서 USG와 기기들을 설정할 시간이다. 먼저 컴퓨터로 컨트롤러에 접속할 수 있도록 준비해야 한다. 

먼저 USG를 리셋한 후 \(어차피 유니파이 제품군들은 SDN이라 디바이스 상태가 그리 중요하지 않다\) 스위치를 연결하고 그 스위치에 노트북과 컨트롤러를 연결해서 네트워크를 준비했다.

```text
  +------+     +------------------+    +-----+
  | USG  |     |      switch      |    | RPi |
  +----+-+     +------------------+    +-+---+
       |         |      |         |      |
       +---------+      |         +------+
                   +---------+
                   | Macbook |
                   +---------+
```

그 다음에  웹 브라우저를 통해 컨트롤러를 접속한 후 클린 설치를 수행했다. \(이번에는 백업 주기도 짧게 설정했다.\)

